System.register(["./p-ad2aa800.system.js"],(function(e){"use strict";var r,t,n,s,i,o;return{setters:[function(e){r=e.r;t=e.N;n=e.c;s=e._;i=e.A;o=e.e}],execute:function(){function a(e,t){var n=t;n.rawResponse=false;return r(e,n).then((function(e){var r={token:e.access_token,username:e.username,expires:new Date(Date.now()+(e.expires_in*1e3-1e3)),ssl:e.ssl===true};if(e.refresh_token){r.refreshToken=e.refresh_token}return r}))}function u(e,n){var s=n;if(typeof window!=="undefined"&&window.location&&window.location.host){s.params.referer=window.location.host}else{s.params.referer=t}return r(e,s)}var h=/^https?:\/\/(\S+)\.arcgis\.com.+/;function p(e){return h.test(e)}function f(e){if(!h.test(e)){return e}switch(c(e)){case"dev":return"https://devext.arcgis.com/sharing/rest";case"qa":return"https://qaext.arcgis.com/sharing/rest";default:return"https://www.arcgis.com/sharing/rest"}}function c(e){if(!h.test(e)){return null}var r=e.match(h);var t=r[1].split(".").pop();if(t.includes("dev")){return"dev"}if(t.includes("qa")){return"qa"}return"production"}function l(e,r){var t=n(f(r)).replace(/https?:\/\//,"");var s=n(e).replace(/https?:\/\//,"");return new RegExp(s,"i").test(t)}function d(e,r){var t=p(e);var n=p(r);var s=c(e);var i=c(r);if(t&&n&&s===i){return true}return false}function k(){var e={promise:null,resolve:null,reject:null};e.promise=new Promise((function(r,t){e.resolve=r;e.reject=t}));return e}var _=e("U",function(){function e(e){this.clientId=e.clientId;this._refreshToken=e.refreshToken;this._refreshTokenExpires=e.refreshTokenExpires;this.username=e.username;this.password=e.password;this._token=e.token;this._tokenExpires=e.tokenExpires;this.portal=e.portal?n(e.portal):"https://www.arcgis.com/sharing/rest";this.ssl=e.ssl;this.provider=e.provider||"arcgis";this.tokenDuration=e.tokenDuration||20160;this.redirectUri=e.redirectUri;this.refreshTokenTTL=e.refreshTokenTTL||1440;this.trustedServers={};if(e.server){var r=this.getServerRootUrl(e.server);this.trustedServers[r]={token:e.token,expires:e.tokenExpires}}this._pendingTokenRequests={}}e.beginOAuth2=function(r,t){if(t===void 0){t=window}var n=s({portal:"https://www.arcgis.com/sharing/rest",provider:"arcgis",duration:20160,popup:true,state:r.clientId,locale:""},r),a=n.portal,u=n.provider,h=n.clientId,p=n.duration,f=n.redirectUri,c=n.popup,l=n.state,d=n.locale,_=n.params;var T;if(u==="arcgis"){T=a+"/oauth2/authorize?client_id="+h+"&response_type=token&expiration="+p+"&redirect_uri="+encodeURIComponent(f)+"&state="+l+"&locale="+d}else{T=a+"/oauth2/social/authorize?client_id="+h+"&socialLoginProviderName="+u+"&autoAccountCreateForSocial=true&response_type=token&expiration="+p+"&redirect_uri="+encodeURIComponent(f)+"&state="+l+"&locale="+d}if(_){T=T+"&"+o(_)}if(!c){t.location.href=T;return undefined}var m=k();t["__ESRI_REST_AUTH_HANDLER_"+h]=function(r,t){if(r){var n=JSON.parse(r);m.reject(new i(n.errorMessage,n.error));return}if(t){var s=JSON.parse(t);m.resolve(new e({clientId:h,portal:a,ssl:s.ssl,token:s.token,tokenExpires:new Date(s.expires),username:s.username}))}};t.open(T,"oauth-window","height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes");return m.promise};e.completeOAuth2=function(r,t){if(t===void 0){t=window}var n=s({portal:"https://www.arcgis.com/sharing/rest",popup:true},r),o=n.portal,a=n.clientId,u=n.popup;function h(r,n){try{if(u&&t.opener&&t.opener.parent&&t.opener.parent["__ESRI_REST_AUTH_HANDLER_"+a]){var s=t.opener.parent["__ESRI_REST_AUTH_HANDLER_"+a];if(s){s(r?JSON.stringify(r):undefined,JSON.stringify(n))}t.close();return undefined}if(u&&t!==t.parent&&t.parent&&t.parent["__ESRI_REST_AUTH_HANDLER_"+a]){var s=t.parent["__ESRI_REST_AUTH_HANDLER_"+a];if(s){s(r?JSON.stringify(r):undefined,JSON.stringify(n))}t.close();return undefined}}catch(h){throw new i('Unable to complete authentication. It\'s possible you specified popup based oAuth2 but no handler from "beginOAuth2()" present. This generally happens because the "popup" option differs between "beginOAuth2()" and "completeOAuth2()".')}if(r){throw new i(r.errorMessage,r.error)}return new e({clientId:a,portal:o,ssl:n.ssl,token:n.token,tokenExpires:n.expires,username:n.username})}var p=t.location.href.match(/access_token=(.+)&expires_in=(.+)&username=([^&]+)/);if(!p){var f=t.location.href.match(/error=(.+)&error_description=(.+)/);var c=f[1];var l=decodeURIComponent(f[2]);return h({error:c,errorMessage:l})}var d=p[1];var k=new Date(Date.now()+parseInt(p[2],10)*1e3-60*1e3);var _=decodeURIComponent(p[3]);var T=t.location.href.indexOf("&ssl=true")>-1||t.location.href.indexOf("#ssl=true")>-1;return h(undefined,{token:d,expires:k,ssl:T,username:_})};e.authorize=function(e,r){var t=s({portal:"https://arcgis.com/sharing/rest",duration:20160},e),n=t.portal,i=t.clientId,o=t.duration,a=t.redirectUri;r.writeHead(301,{Location:n+"/oauth2/authorize?client_id="+i+"&duration="+o+"&response_type=code&redirect_uri="+encodeURIComponent(a)});r.end()};e.exchangeAuthorizationCode=function(r,t){var n=s({portal:"https://www.arcgis.com/sharing/rest",refreshTokenTTL:1440},r),i=n.portal,o=n.clientId,u=n.redirectUri,h=n.refreshTokenTTL;return a(i+"/oauth2/token",{params:{grant_type:"authorization_code",client_id:o,redirect_uri:u,code:t}}).then((function(r){return new e({clientId:o,portal:i,ssl:r.ssl,redirectUri:u,refreshToken:r.refreshToken,refreshTokenTTL:h,refreshTokenExpires:new Date(Date.now()+(h-1)*1e3),token:r.token,tokenExpires:r.expires,username:r.username})}))};e.deserialize=function(r){var t=JSON.parse(r);return new e({clientId:t.clientId,refreshToken:t.refreshToken,refreshTokenExpires:new Date(t.refreshTokenExpires),username:t.username,password:t.password,token:t.token,tokenExpires:new Date(t.tokenExpires),portal:t.portal,ssl:t.ssl,tokenDuration:t.tokenDuration,redirectUri:t.redirectUri,refreshTokenTTL:t.refreshTokenTTL})};e.fromCredential=function(r){return new e({portal:r.server.includes("sharing/rest")?r.server:r.server+"/sharing/rest",ssl:r.ssl,token:r.token,username:r.userId,tokenExpires:new Date(r.expires)})};Object.defineProperty(e.prototype,"token",{get:function(){return this._token},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"tokenExpires",{get:function(){return this._tokenExpires},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this._refreshToken},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"refreshTokenExpires",{get:function(){return this._refreshTokenExpires},enumerable:true,configurable:true});e.prototype.toCredential=function(){return{expires:this.tokenExpires.getTime(),server:this.portal,ssl:this.ssl,token:this.token,userId:this.username}};e.prototype.getUser=function(e){var t=this;if(this._pendingUserRequest){return this._pendingUserRequest}else if(this._user){return Promise.resolve(this._user)}else{var n=this.portal+"/community/self";var i=s({httpMethod:"GET",authentication:this},e,{rawResponse:false});this._pendingUserRequest=r(n,i).then((function(e){t._user=e;t._pendingUserRequest=null;return e}));return this._pendingUserRequest}};e.prototype.getUsername=function(){if(this.username){return Promise.resolve(this.username)}else if(this._user){return Promise.resolve(this._user.username)}else{return this.getUser().then((function(e){return e.username}))}};e.prototype.getToken=function(e,r){if(d(this.portal,e)){return this.getFreshToken(r)}else if(new RegExp(this.portal,"i").test(e)){return this.getFreshToken(r)}else{return this.getTokenForServer(e,r)}};e.prototype.toJSON=function(){return{clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires,portal:this.portal,ssl:this.ssl,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,refreshTokenTTL:this.refreshTokenTTL}};e.prototype.serialize=function(){return JSON.stringify(this)};e.prototype.refreshSession=function(e){this._user=null;if(this.username&&this.password){return this.refreshWithUsernameAndPassword(e)}if(this.clientId&&this.refreshToken){return this.refreshWithRefreshToken()}return Promise.reject(new i("Unable to refresh token."))};e.prototype.getServerRootUrl=function(e){var r=n(e).split(/\/rest(\/admin)?\/services(?:\/|#|\?|$)/)[0];var t=r.match(/(https?:\/\/)(.+)/),s=t[1],i=t[2];var o=i.split("/"),a=o[0],u=o.slice(1);return""+s+a.toLowerCase()+"/"+u.join("/")};e.prototype.getTokenForServer=function(e,t){var n=this;var s=this.getServerRootUrl(e);var o=this.trustedServers[s];if(o&&o.expires&&o.expires.getTime()>Date.now()){return Promise.resolve(o.token)}if(this._pendingTokenRequests[s]){return this._pendingTokenRequests[s]}this._pendingTokenRequests[s]=r(s+"/rest/info").then((function(o){if(o.owningSystemUrl){if(!l(o.owningSystemUrl,n.portal)){throw new i(e+" is not federated with "+n.portal+".","NOT_FEDERATED")}else{return r(o.owningSystemUrl+"/sharing/rest/info",t)}}else if(o.authInfo&&n.trustedServers[s]!==undefined){return Promise.resolve({authInfo:o.authInfo})}else{throw new i(e+" is not federated with any portal and is not explicitly trusted.","NOT_FEDERATED")}})).then((function(e){return e.authInfo.tokenServicesUrl})).then((function(r){if(n.token&&n.tokenExpires.getTime()>Date.now()){return u(r,{params:{token:n.token,serverUrl:e,expiration:n.tokenDuration,client:"referer"}})}else{return u(r,{params:{username:n.username,password:n.password,expiration:n.tokenDuration,client:"referer"}}).then((function(e){n._token=e.token;n._tokenExpires=new Date(e.expires);return e}))}})).then((function(e){n.trustedServers[s]={expires:new Date(e.expires),token:e.token};delete n._pendingTokenRequests[s];return e.token}));return this._pendingTokenRequests[s]};e.prototype.getFreshToken=function(e){var r=this;if(this.token&&!this.tokenExpires){return Promise.resolve(this.token)}if(this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()){return Promise.resolve(this.token)}if(!this._pendingTokenRequests[this.portal]){this._pendingTokenRequests[this.portal]=this.refreshSession(e).then((function(e){r._pendingTokenRequests[r.portal]=null;return e.token}))}return this._pendingTokenRequests[this.portal]};e.prototype.refreshWithUsernameAndPassword=function(e){var r=this;var t=s({params:{username:this.username,password:this.password,expiration:this.tokenDuration}},e);return u(this.portal+"/generateToken",t).then((function(e){r._token=e.token;r._tokenExpires=new Date(e.expires);return r}))};e.prototype.refreshWithRefreshToken=function(e){var r=this;if(this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()<Date.now()){return this.refreshRefreshToken(e)}var t=s({params:{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}},e);return a(this.portal+"/oauth2/token",t).then((function(e){r._token=e.token;r._tokenExpires=e.expires;return r}))};e.prototype.refreshRefreshToken=function(e){var r=this;var t=s({params:{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}},e);return a(this.portal+"/oauth2/token",t).then((function(e){r._token=e.token;r._tokenExpires=e.expires;r._refreshToken=e.refreshToken;r._refreshTokenExpires=new Date(Date.now()+(r.refreshTokenTTL-1)*60*1e3);return r}))};return e}())}}}));