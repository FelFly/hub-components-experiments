System.register(["./p-bda334d9.system.js","./p-efd827df.system.js","./p-adc488b3.system.js","./p-8acf3331.system.js","./p-f6d2a683.system.js","./p-685036c5.system.js"],(function(e){"use strict";var t,i,n,r,a,s,o,u,c,l,f,d,p,m,v;return{setters:[function(e){t=e.r;i=e.h},function(e){n=e.r;r=e.f},function(e){a=e.g;s=e.a;o=e.b;u=e.o;c=e.j;l=e.l},function(e){f=e.b;d=e.j;p=e.u},function(e){m=e.U},function(e){v=e.a}],execute:function(){function h(e,t){var i=f(e,"item.properties.schemaVersion");if(!i||i<1){var n=d(e);if(!n.data.values){n.data.values={}}if(!n.item.properties){n.item.properties={}}n.item.properties.schemaVersion=1;var r=false;if(n.item.typeKeywords){r=n.item.typeKeywords.indexOf("hubInitiativeTemplate")>=0}var a=!!n.data.source;if(a&&n.item.properties.source!==n.data.source){n.item.properties.source=n.data.source}if(n.data.configurationSettings){var s=d(n.data.configurationSettings);delete n.data.configurationSettings;var o=s.find((function(e){return e.category==="Steps"}));n.data.values.steps=o.fields.map((function(e){return e.fieldName}));o.fields.forEach((function(e){if(!n.data.values[e.fieldName]){n.data.values[e.fieldName]={}}n.data.values[e.fieldName].title=e.label;n.data.values[e.fieldName].description=e.tooltip;n.data.values[e.fieldName].id=e.fieldName;if(n.data.values[e.fieldName].items){if(r){n.data.values[e.fieldName].templates=n.data.values[e.fieldName].items;delete n.data.values[e.fieldName].items}}else{n.data.values[e.fieldName].items=[];n.data.values[e.fieldName].templates=[]}}))}return n}else{return e}}function g(e,t){var i=f(e,"item.properties.schemaVersion");if(i<1.1){var n=d(e);n.item.properties.schemaVersion=1.1;y(n,t);if(!n.data.values.bannerImage){n.data.values.bannerImage={source:"bannerImage",display:{position:{x:"50%",y:"10%"}}}}return n}else{return e}}function y(e,t){if(!e.data.assets){e.data.assets=[{id:"bannerImage",url:w(e.item.id,"detail-image.jpg",t),properties:{type:"resource",fileName:"detail-image.jpg",mimeType:"image/jepg"},license:{type:"none"}},{id:"iconDark",url:w(e.item.id,"icon-dark.png",t),properties:{type:"resource",fileName:"icon-dark.png",mimeType:"image/png"},license:{type:"none"}},{id:"iconLight",url:w(e.item.id,"icon-light.png",t),properties:{type:"resource",fileName:"icon-light.png",mimeType:"image/png"},license:{type:"none"}}]}return e}function w(e,t,i,n){var r=i||"https://www.arcgis.com/sharing/rest";var a=r+"/content/items/"+e+"/resources";if(n){a=a+"/"+n+"/"+t}else{a=a+"/"+t}return a}var I=function(e){var t=false;if(Array.isArray(e.fields)&&e.fields.length>0){t=true}return t};var x=function(e){return Object.keys(e).reduce((function(t,i){var n=e[i];if(I(n)){var r=d(n);r.id=i;t.push(r)}return t}),[])};var b=function(e){return{id:e.id,name:e.field.name,alias:e.field.alias,type:e.field.type}};var N=function(e){return{type:"Feature Layer",url:e.url,itemId:e.itemId,layerId:e.layerId,name:e.name||e.id,mappings:e.fields.map(b)}};var j=function(e){var t={id:e.id,type:"Data",name:e.name||e.id,definition:{description:e.name||e.id},source:N(e)};return t};var O=function(e){return x(e).map(j)};var T=function(e){var t=e.templates||[];var i=e.items||[];return{title:e.title,description:e.description,id:e.id,templateIds:t.map(A),itemIds:i.map(A)}};var F=function(e,t){if(e&&Array.isArray(e)){return e.map((function(e){return T(t[e])}))}else{return[]}};function A(e){return e.id}function S(e,t){var i=f(e,"item.properties.schemaVersion");if(i<2){var n=d(e);n.item.properties.schemaVersion=2;n.data.steps=F(n.data.values.steps,n.data.values);if(n.data.values.steps){n.data.values.steps.forEach((function(e){delete n.data.values[e]}));delete n.data.values.steps}n.data.indicators=O(n.data.values);return n}else{return e}}function V(e){var t=f(e,"item.properties.schemaVersion");if(t<2.1){var i=d(e);i.item.properties.schemaVersion=2.1;var n=f(e,"item.properties.groupId");if(n){i.item.properties.collaborationGroupId=n;delete i.item.properties.groupId}return i}else{return e}}function P(e){var t=d(e);var i=f(t,"data.steps");var n=G(i);var r=f(t,"data.recommendedTemplates")||[];var a=n.concat(r);t.data.recommendedTemplates=a.reduce((function(e,t){if(e.indexOf(t)<0){e.push(t)}return e}),[]);return t}function G(e){var t=[];if(Array.isArray(e)){t=e.reduce((function(e,t){if(f(t,"templateIds.length")){return e.concat(t.templateIds)}return e}),[])}return t}var k=2.2;function z(e,t){if(f(e,"item.properties.schemaVersion")===k){return e}else{e=h(e);e=g(e,t);e=S(e);e=V(e);e=P(e);return e}}function J(e,t){return Promise.all([a(e,t),s(e,t)]).then((function(e){return{item:e[0],data:e[1]}})).then((function(e){return z(e,o(t))}))}var D=function(e){return"hubInitiativeId|"+e};var E=function(e){return e.replace(/^hubInitiativeId\|/,"")};var K=function(e){return e.replace(/^hubInitiativeFollowers\|/,"")};var L=function(e){return u(e)+"/update"};var M=function(e){return e.tags.map(E)};var U=function(e){return e.groups.map((function(e){return e.tags})).reduce((function(e,t){return e.concat(t)}),[]).filter((function(e){return e.indexOf("hubInitiativeFollowers|")===0})).map(K)};var _=function(e){var t=M(e);var i=U(e);return r(t,i).filter(p)};var B=function(e,t){return _(e).indexOf(t)>-1};function C(e){return n(u(e.authentication),{authentication:e.authentication}).then((function(t){if(B(t,e.initiativeId)){return Promise.reject("user is already following this initiative.")}return t})).then((function(t){return J(e.initiativeId,e).then((function(e){return{user:t,initiative:e,hasFollowersGroup:false}}))})).then((function(t){var i=f(t,"initiative.item.properties.followersGroupId");if(i){return c({id:i,authentication:e.authentication}).then((function(e){t.hasFollowersGroup=e.success;return t}))}return t})).then((function(t){if(!t.hasFollowersGroup){var i=D(e.initiativeId);var r=JSON.parse(JSON.stringify(t.user.tags));r.push(i);return n(L(e.authentication),{params:{tags:r},authentication:e.authentication})}return{success:true,username:t.user.username}}))}function q(e){return n(u(e.authentication),{authentication:e.authentication}).then((function(t){if(!B(t,e.initiativeId)){return Promise.reject("user is not following this initiative.")}return t})).then((function(t){var i=D(e.initiativeId);var r=JSON.parse(JSON.stringify(t.tags));if(r.indexOf(i)>-1){var a=r.indexOf(i);r.splice(a,1);if(r.length===0){r.push(",")}return n(L(e.authentication),{params:{tags:r},authentication:e.authentication}).then((function(e){return t}))}return t})).then((function(t){return J(e.initiativeId,e).then((function(e){return{user:t,initiative:e}}))})).then((function(t){var i=f(t,"initiative.item.properties.followersGroupId");if(i&&U(t.user).indexOf(e.initiativeId)>-1){return l({id:i,authentication:e.authentication}).then((function(e){return{success:true,username:t.user.username}}))}return{success:true,username:t.user.username}}))}var H=".follow-icon{height:15px;width:15px;vertical-align:baseline;padding-right:5px;fill:currentColor}";var Q=e("hub_follow_button",function(){function e(e){var n=this;t(this,e);this.icon=i("svg",{class:"follow-icon",viewBox:"0 0 120 120",width:"100%",height:"100%"},i("circle",{cx:"18.385",cy:"101.615",r:"18.385"}),i("path",{d:"M-1.031 61c32.533 0 59 26.468 59 59s-26.467 59-59 59-59-26.468-59-59 26.467-59 59-59m0-23c-45.288 0-82 36.713-82 82s36.712 82 82 82 82-36.713 82-82-36.712-82-82-82z"}),i("path",{d:"M.154 23.041c53.349 0 96.75 43.402 96.75 96.75s-43.402 96.75-96.75 96.75-96.75-43.402-96.75-96.75 43.402-96.75 96.75-96.75m0-23c-66.136 0-119.75 53.615-119.75 119.75s53.614 119.75 119.75 119.75c66.135 0 119.75-53.615 119.75-119.75S66.289.041.154.041z"}));this.orgurl="https://www.arcgis.com";this.following=false;this.followtext="Follow Our Initiative";this.unfollowtext="Unfollow Our Initiative";this.callToActionText=this.followtext;this.triggerFollow=function(){return v(n.clientid,n.orgurl).then((function(e){n.session=e;return n.toggleFollow()}))};this.toggleFollow=function(){console.log("toggleFollow",n.following);if(!n.following){return C({initiativeId:n.initiativeid,authentication:m.deserialize(n.session)}).then((function(e){if(e.success)return Promise.resolve(e)})).catch((function(e){if(e==="user is already following this initiative.")return Promise.resolve()})).then((function(){n.callToActionText=n.followtext;n.following=true;return{success:true}}))}else{return q({initiativeId:n.initiativeid,authentication:m.deserialize(n.session)}).then((function(e){if(e.success)return Promise.resolve()})).catch((function(e){if(e==="user is not following this initiative.")return Promise.resolve()})).then((function(){n.callToActionText=n.unfollowtext;n.following=false;return{success:true}}))}}}e.prototype.render=function(){return i("hub-button",{text:this.callToActionText,action:this.triggerFollow,icon:this.icon})};return e}());Q.style=H}}}));