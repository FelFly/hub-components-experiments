import{r as e,N as t,c as r,_ as n,A as i,e as s}from"./p-3a73ba05.js";function o(t,r){var n=r;return n.rawResponse=!1,e(t,n).then((function(e){var t={token:e.access_token,username:e.username,expires:new Date(Date.now()+(1e3*e.expires_in-1e3)),ssl:!0===e.ssl};return e.refresh_token&&(t.refreshToken=e.refresh_token),t}))}function a(r,n){var i=n;return i.params.referer="undefined"!=typeof window&&window.location&&window.location.host?window.location.host:t,e(r,i)}var h=/^https?:\/\/(\S+)\.arcgis\.com.+/;function u(e){return h.test(e)}function c(e){if(!h.test(e))return null;var t=e.match(h)[1].split(".").pop();return t.includes("dev")?"dev":t.includes("qa")?"qa":"production"}var p=function(){function t(e){if(this.clientId=e.clientId,this._refreshToken=e.refreshToken,this._refreshTokenExpires=e.refreshTokenExpires,this.username=e.username,this.password=e.password,this._token=e.token,this._tokenExpires=e.tokenExpires,this.portal=e.portal?r(e.portal):"https://www.arcgis.com/sharing/rest",this.ssl=e.ssl,this.provider=e.provider||"arcgis",this.tokenDuration=e.tokenDuration||20160,this.redirectUri=e.redirectUri,this.refreshTokenTTL=e.refreshTokenTTL||1440,this.trustedServers={},e.server){var t=this.getServerRootUrl(e.server);this.trustedServers[t]={token:e.token,expires:e.tokenExpires}}this._pendingTokenRequests={}}return t.beginOAuth2=function(e,r){void 0===r&&(r=window);var o,a=n({portal:"https://www.arcgis.com/sharing/rest",provider:"arcgis",duration:20160,popup:!0,state:e.clientId,locale:""},e),h=a.portal,u=a.provider,c=a.clientId,p=a.duration,f=a.redirectUri,l=a.popup,d=a.state,w=a.locale,_=a.params;if(o="arcgis"===u?h+"/oauth2/authorize?client_id="+c+"&response_type=token&expiration="+p+"&redirect_uri="+encodeURIComponent(f)+"&state="+d+"&locale="+w:h+"/oauth2/social/authorize?client_id="+c+"&socialLoginProviderName="+u+"&autoAccountCreateForSocial=true&response_type=token&expiration="+p+"&redirect_uri="+encodeURIComponent(f)+"&state="+d+"&locale="+w,_&&(o=o+"&"+s(_)),l){var m,v=((m={promise:null,resolve:null,reject:null}).promise=new Promise((function(e,t){m.resolve=e,m.reject=t})),m);return r["__ESRI_REST_AUTH_HANDLER_"+c]=function(e,r){if(e){var n=JSON.parse(e);v.reject(new i(n.errorMessage,n.error))}else if(r){var s=JSON.parse(r);v.resolve(new t({clientId:c,portal:h,ssl:s.ssl,token:s.token,tokenExpires:new Date(s.expires),username:s.username}))}},r.open(o,"oauth-window","height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes"),v.promise}r.location.href=o},t.completeOAuth2=function(e,r){void 0===r&&(r=window);var s=n({portal:"https://www.arcgis.com/sharing/rest",popup:!0},e),o=s.portal,a=s.clientId,h=s.popup;function u(e,n){try{var s;if(h&&r.opener&&r.opener.parent&&r.opener.parent["__ESRI_REST_AUTH_HANDLER_"+a])return(s=r.opener.parent["__ESRI_REST_AUTH_HANDLER_"+a])&&s(e?JSON.stringify(e):void 0,JSON.stringify(n)),void r.close();if(h&&r!==r.parent&&r.parent&&r.parent["__ESRI_REST_AUTH_HANDLER_"+a])return(s=r.parent["__ESRI_REST_AUTH_HANDLER_"+a])&&s(e?JSON.stringify(e):void 0,JSON.stringify(n)),void r.close()}catch(u){throw new i('Unable to complete authentication. It\'s possible you specified popup based oAuth2 but no handler from "beginOAuth2()" present. This generally happens because the "popup" option differs between "beginOAuth2()" and "completeOAuth2()".')}if(e)throw new i(e.errorMessage,e.error);return new t({clientId:a,portal:o,ssl:n.ssl,token:n.token,tokenExpires:n.expires,username:n.username})}var c=r.location.href.match(/access_token=(.+)&expires_in=(.+)&username=([^&]+)/);if(!c){var p=r.location.href.match(/error=(.+)&error_description=(.+)/);return u({error:p[1],errorMessage:decodeURIComponent(p[2])})}var f=c[1],l=new Date(Date.now()+1e3*parseInt(c[2],10)-6e4),d=decodeURIComponent(c[3]);return u(void 0,{token:f,expires:l,ssl:r.location.href.indexOf("&ssl=true")>-1||r.location.href.indexOf("#ssl=true")>-1,username:d})},t.authorize=function(e,t){var r=n({portal:"https://arcgis.com/sharing/rest",duration:20160},e);t.writeHead(301,{Location:r.portal+"/oauth2/authorize?client_id="+r.clientId+"&duration="+r.duration+"&response_type=code&redirect_uri="+encodeURIComponent(r.redirectUri)}),t.end()},t.exchangeAuthorizationCode=function(e,r){var i=n({portal:"https://www.arcgis.com/sharing/rest",refreshTokenTTL:1440},e),s=i.portal,a=i.clientId,h=i.redirectUri,u=i.refreshTokenTTL;return o(s+"/oauth2/token",{params:{grant_type:"authorization_code",client_id:a,redirect_uri:h,code:r}}).then((function(e){return new t({clientId:a,portal:s,ssl:e.ssl,redirectUri:h,refreshToken:e.refreshToken,refreshTokenTTL:u,refreshTokenExpires:new Date(Date.now()+1e3*(u-1)),token:e.token,tokenExpires:e.expires,username:e.username})}))},t.deserialize=function(e){var r=JSON.parse(e);return new t({clientId:r.clientId,refreshToken:r.refreshToken,refreshTokenExpires:new Date(r.refreshTokenExpires),username:r.username,password:r.password,token:r.token,tokenExpires:new Date(r.tokenExpires),portal:r.portal,ssl:r.ssl,tokenDuration:r.tokenDuration,redirectUri:r.redirectUri,refreshTokenTTL:r.refreshTokenTTL})},t.fromCredential=function(e){return new t({portal:e.server.includes("sharing/rest")?e.server:e.server+"/sharing/rest",ssl:e.ssl,token:e.token,username:e.userId,tokenExpires:new Date(e.expires)})},Object.defineProperty(t.prototype,"token",{get:function(){return this._token},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tokenExpires",{get:function(){return this._tokenExpires},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"refreshToken",{get:function(){return this._refreshToken},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"refreshTokenExpires",{get:function(){return this._refreshTokenExpires},enumerable:!0,configurable:!0}),t.prototype.toCredential=function(){return{expires:this.tokenExpires.getTime(),server:this.portal,ssl:this.ssl,token:this.token,userId:this.username}},t.prototype.getUser=function(t){var r=this;if(this._pendingUserRequest)return this._pendingUserRequest;if(this._user)return Promise.resolve(this._user);var i=this.portal+"/community/self",s=n({httpMethod:"GET",authentication:this},t,{rawResponse:!1});return this._pendingUserRequest=e(i,s).then((function(e){return r._user=e,r._pendingUserRequest=null,e})),this._pendingUserRequest},t.prototype.getUsername=function(){return this.username?Promise.resolve(this.username):this._user?Promise.resolve(this._user.username):this.getUser().then((function(e){return e.username}))},t.prototype.getToken=function(e,t){return n=e,i=u(r=this.portal),s=u(n),o=c(r),a=c(n),i&&s&&o===a||new RegExp(this.portal,"i").test(e)?this.getFreshToken(t):this.getTokenForServer(e,t);var r,n,i,s,o,a},t.prototype.toJSON=function(){return{clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires,portal:this.portal,ssl:this.ssl,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,refreshTokenTTL:this.refreshTokenTTL}},t.prototype.serialize=function(){return JSON.stringify(this)},t.prototype.refreshSession=function(e){return this._user=null,this.username&&this.password?this.refreshWithUsernameAndPassword(e):this.clientId&&this.refreshToken?this.refreshWithRefreshToken():Promise.reject(new i("Unable to refresh token."))},t.prototype.getServerRootUrl=function(e){var t=r(e).split(/\/rest(\/admin)?\/services(?:\/|#|\?|$)/)[0].match(/(https?:\/\/)(.+)/),n=t[1],i=t[2].split("/"),s=i[0],o=i.slice(1);return""+n+s.toLowerCase()+"/"+o.join("/")},t.prototype.getTokenForServer=function(t,n){var s=this,o=this.getServerRootUrl(t),u=this.trustedServers[o];return u&&u.expires&&u.expires.getTime()>Date.now()?Promise.resolve(u.token):(this._pendingTokenRequests[o]||(this._pendingTokenRequests[o]=e(o+"/rest/info").then((function(a){if(a.owningSystemUrl){if(u=a.owningSystemUrl,p=r(function(e){if(!h.test(e))return e;switch(c(e)){case"dev":return"https://devext.arcgis.com/sharing/rest";case"qa":return"https://qaext.arcgis.com/sharing/rest";default:return"https://www.arcgis.com/sharing/rest"}}(s.portal)).replace(/https?:\/\//,""),f=r(u).replace(/https?:\/\//,""),new RegExp(f,"i").test(p))return e(a.owningSystemUrl+"/sharing/rest/info",n);throw new i(t+" is not federated with "+s.portal+".","NOT_FEDERATED")}var u,p,f;if(a.authInfo&&void 0!==s.trustedServers[o])return Promise.resolve({authInfo:a.authInfo});throw new i(t+" is not federated with any portal and is not explicitly trusted.","NOT_FEDERATED")})).then((function(e){return e.authInfo.tokenServicesUrl})).then((function(e){return s.token&&s.tokenExpires.getTime()>Date.now()?a(e,{params:{token:s.token,serverUrl:t,expiration:s.tokenDuration,client:"referer"}}):a(e,{params:{username:s.username,password:s.password,expiration:s.tokenDuration,client:"referer"}}).then((function(e){return s._token=e.token,s._tokenExpires=new Date(e.expires),e}))})).then((function(e){return s.trustedServers[o]={expires:new Date(e.expires),token:e.token},delete s._pendingTokenRequests[o],e.token}))),this._pendingTokenRequests[o])},t.prototype.getFreshToken=function(e){var t=this;return this.token&&!this.tokenExpires||this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()?Promise.resolve(this.token):(this._pendingTokenRequests[this.portal]||(this._pendingTokenRequests[this.portal]=this.refreshSession(e).then((function(e){return t._pendingTokenRequests[t.portal]=null,e.token}))),this._pendingTokenRequests[this.portal])},t.prototype.refreshWithUsernameAndPassword=function(e){var t=this,r=n({params:{username:this.username,password:this.password,expiration:this.tokenDuration}},e);return a(this.portal+"/generateToken",r).then((function(e){return t._token=e.token,t._tokenExpires=new Date(e.expires),t}))},t.prototype.refreshWithRefreshToken=function(e){var t=this;if(this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()<Date.now())return this.refreshRefreshToken(e);var r=n({params:{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}},e);return o(this.portal+"/oauth2/token",r).then((function(e){return t._token=e.token,t._tokenExpires=e.expires,t}))},t.prototype.refreshRefreshToken=function(e){var t=this,r=n({params:{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}},e);return o(this.portal+"/oauth2/token",r).then((function(e){return t._token=e.token,t._tokenExpires=e.expires,t._refreshToken=e.refreshToken,t._refreshTokenExpires=new Date(Date.now()+60*(t.refreshTokenTTL-1)*1e3),t}))},t}();export{p as U}